<Window x:Class="Revit26_Plugin.APUS_V312.Views.AutoPlaceSectionsWindow" 
        xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
        xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
        xmlns:local="clr-namespace:Revit26_Plugin.APUS_V312.Views"
        Title="Auto Place Sections"
        Height="900"
        Width="1250"
        WindowStartupLocation="CenterOwner"
        ResizeMode="CanResize">

    <Window.Resources>
        <!-- Converter to invert boolean (enable button when NOT placing) -->
        <local:BooleanToNotConverter x:Key="BooleanToNotConverter"/>

        <!-- Converter for boolean to visibility -->
        <local:BooleanToVisibilityConverter x:Key="BooleanToVisibilityConverter"/>

        <!-- Converter for log level colors -->
        <local:LogLevelToBrushConverter x:Key="LogLevelToBrushConverter"/>
    </Window.Resources>

    <Grid Margin="10">
        <Grid.RowDefinitions>
            <RowDefinition Height="Auto"/>
            <RowDefinition Height="*"/>
            <RowDefinition Height="220"/>
        </Grid.RowDefinitions>

        <!-- ================= INPUT PANEL ================= -->

        <Border Grid.Row="0"
                BorderBrush="#CFCFCF"
                BorderThickness="1"
                CornerRadius="4"
                Padding="10"
                Margin="0,0,0,10">

            <StackPanel>

                <!-- TITLE BLOCK -->
                <GroupBox Header="Title Block" Margin="0,0,0,10">
                    <ComboBox ItemsSource="{Binding TitleBlocks}"
                              SelectedItem="{Binding SelectedTitleBlock}"
                              DisplayMemberPath="DisplayName"
                              MinHeight="26"
                              Margin="5"
                              IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                </GroupBox>

                <!-- FILTERS -->
                <GroupBox Header="Filters" Margin="0,0,0,10">
                    <Grid Margin="5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="240"/>
                            <ColumnDefinition Width="240"/>
                            <ColumnDefinition Width="240"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Placement Scope"/>
                            <ComboBox ItemsSource="{Binding PlacementScopes}"
                                      SelectedItem="{Binding SelectedPlacementScope}"
                                      MinHeight="26"
                                      IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="10,0,0,0">
                            <TextBlock Text="Placement State"/>
                            <ComboBox ItemsSource="{Binding PlacementStates}"
                                      SelectedItem="{Binding SelectedPlacementState}"
                                      MinHeight="26"
                                      IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Margin="10,0,0,0">
                            <TextBlock Text="Sheet Filter"/>
                            <ComboBox ItemsSource="{Binding SheetNumberOptions}"
                                      SelectedItem="{Binding SheetNumberFilter}"
                                      MinHeight="26"
                                      IsEditable="False"
                                      IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>

                <!-- LAYOUT -->
                <GroupBox Header="Layout Settings (mm)">
                    <Grid Margin="5">
                        <Grid.ColumnDefinitions>
                            <ColumnDefinition Width="240"/>
                            <ColumnDefinition Width="240"/>
                            <ColumnDefinition Width="240"/>
                            <ColumnDefinition Width="240"/>
                        </Grid.ColumnDefinitions>

                        <StackPanel Grid.Column="0">
                            <TextBlock Text="Left Margin"/>
                            <TextBox Text="{Binding LeftMarginMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                            <TextBlock Text="Top Margin"/>
                            <TextBox Text="{Binding TopMarginMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="1" Margin="10,0,0,0">
                            <TextBlock Text="Right Margin"/>
                            <TextBox Text="{Binding RightMarginMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                            <TextBlock Text="Bottom Margin"/>
                            <TextBox Text="{Binding BottomMarginMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="2" Margin="10,0,0,0">
                            <TextBlock Text="Horizontal Gap"/>
                            <TextBox Text="{Binding HorizontalGapMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                            <TextBlock Text="Vertical Gap"/>
                            <TextBox Text="{Binding VerticalGapMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>

                        <StackPanel Grid.Column="3" Margin="10,0,0,0">
                            <TextBlock Text="Y Tolerance"/>
                            <TextBox Text="{Binding YToleranceMm, UpdateSourceTrigger=PropertyChanged}"
                                     IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>
                        </StackPanel>
                    </Grid>
                </GroupBox>

            </StackPanel>
        </Border>

        <!-- ================= SECTION LIST ================= -->

        <DataGrid Grid.Row="1"
                  ItemsSource="{Binding FilteredSections}"
                  AutoGenerateColumns="False"
                  CanUserAddRows="False"
                  CanUserDeleteRows="False"
                  SelectionMode="Extended"
                  Margin="0,0,0,10"
                  IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}">

            <DataGrid.Columns>

                <DataGridCheckBoxColumn Width="40"
                                        Binding="{Binding IsSelected, Mode=TwoWay, UpdateSourceTrigger=PropertyChanged}"
                                        IsReadOnly="{Binding IsPlacing}"/>

                <DataGridTextColumn Header="Section"
                                    Binding="{Binding ViewName}"
                                    Width="*"
                                    IsReadOnly="True"/>

                <DataGridTextColumn Header="Scope"
                                    Binding="{Binding PlacementScope}"
                                    Width="140"
                                    IsReadOnly="True"/>

                <DataGridTextColumn Header="Sheet"
                                    Binding="{Binding SheetNumber}"
                                    Width="120"
                                    IsReadOnly="True"/>

                <DataGridCheckBoxColumn Header="Placed"
                                        Width="80"
                                        Binding="{Binding IsPlaced, Mode=OneWay}"
                                        IsReadOnly="True"/>

            </DataGrid.Columns>
        </DataGrid>

        <!-- ================= LOG + ACTIONS ================= -->

        <Border Grid.Row="2"
                BorderBrush="#CFCFCF"
                BorderThickness="1"
                CornerRadius="4"
                Padding="8">

            <DockPanel>

                <!-- Progress Bar -->
                <ProgressBar DockPanel.Dock="Top"
                             Value="{Binding Progress.Current, Mode=OneWay}"
                             Maximum="{Binding Progress.Total, Mode=OneWay}"
                             Height="20"
                             Margin="0,0,0,5"
                             Visibility="{Binding IsPlacing, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                <!-- Progress Text -->
                <TextBlock DockPanel.Dock="Top"
                           Text="{Binding Progress.Current, StringFormat=Progress: {0}/{1}, Mode=OneWay}"
                           HorizontalAlignment="Center"
                           Margin="0,0,0,5"
                           Visibility="{Binding IsPlacing, Converter={StaticResource BooleanToVisibilityConverter}}"/>

                <!-- Options -->
                <CheckBox DockPanel.Dock="Top"
                          Content="Open sheets after placement"
                          IsChecked="{Binding OpenSheetsAfterPlacement}"
                          Margin="4,5,4,10"
                          IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>

                <StackPanel DockPanel.Dock="Top"
                            Orientation="Horizontal"
                            HorizontalAlignment="Right"
                            Margin="0,0,0,5">

                    <Button Content="Place"
                            Width="120"
                            Margin="4"
                            Command="{Binding PlaceCommand}"
                            IsEnabled="{Binding IsPlacing, Converter={StaticResource BooleanToNotConverter}}"/>

                    <Button Content="Cancel"
                            Width="120"
                            Margin="4"
                            Command="{Binding CancelCommand}"
                            Visibility="{Binding IsPlacing, Converter={StaticResource BooleanToVisibilityConverter}}"/>
                </StackPanel>

                <!-- Log ListBox -->
                <ListBox ItemsSource="{Binding LogEntries}"
                         VirtualizingStackPanel.IsVirtualizing="True"
                         VirtualizingStackPanel.VirtualizationMode="Recycling"
                         ScrollViewer.VerticalScrollBarVisibility="Auto"
                         ScrollViewer.HorizontalScrollBarVisibility="Auto">
                    <ListBox.ItemTemplate>
                        <DataTemplate>
                            <TextBlock Text="{Binding DisplayText}"
                                       FontSize="12"
                                       TextWrapping="Wrap"
                                       Foreground="{Binding Level, Converter={StaticResource LogLevelToBrushConverter}}"/>
                        </DataTemplate>
                    </ListBox.ItemTemplate>
                </ListBox>

            </DockPanel>
        </Border>

    </Grid>
</Window>